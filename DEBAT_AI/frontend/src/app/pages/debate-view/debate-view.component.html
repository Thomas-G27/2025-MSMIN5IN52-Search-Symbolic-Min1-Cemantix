<div class="container">
  <header class="debate-header">
    
    <!-- Retour -->
    <a routerLink="/" class="icon-btn" title="Exit without saving">âœ•</a>

    <!-- Score -->
    <div class="score-board">
      <div class="score-side side-a" [class.leading]="scoreA > scoreB">
        <span class="score-name">{{ playerA }}</span>
        <span class="score-num">{{ scoreA }}</span>
      </div>
      <div class="vs-badge">VS</div>
      <div class="score-side side-b" [class.leading]="scoreB > scoreA">
        <span class="score-num">{{ scoreB }}</span>
        <span class="score-name">{{ playerB }}</span>
      </div>
    </div>

    <!-- Switcher + Bouton FINISH -->
    <div class="header-actions" style="display: flex; gap: 10px; align-items: center;">
      
      <!-- Switcher -->
      <div class="user-toggle">
        <button 
          class="toggle-btn" 
          [class.active]="username === playerA"
          (click)="switchUser(playerA)">
          {{ playerA }}
        </button>
        <button 
          class="toggle-btn" 
          [class.active]="username === playerB"
          (click)="switchUser(playerB)">
          {{ playerB }}
        </button>
      </div>

      <!-- BOUTON FINISH (NOUVEAU) -->
      <button class="btn-finish" (click)="finishDebate()">
        ğŸ FINISH
      </button>

    </div>

  </header>

  <div class="message-container" #messageContainer>
    <div *ngIf="messages.length === 0" class="loading">
      Loading messages or no messages yet...
    </div>

    <!-- Boucle des messages -->
    <div *ngFor="let msg of messages" class="message" 
         [ngClass]="{
           'my-message': msg.username === username, 
           'other-message': msg.username !== username
         }">
      
      <!-- BULLE DU MESSAGE (Avec classe conditionnelle winner/loser) -->
      <div class="message-bubble" 
           [class.winner-bubble]="isWinner(msg.id)"
           [class.loser-bubble]="!isWinner(msg.id)">
        
        <!-- HEADER MESSAGE : Auteur + Badges IA -->
        <div class="message-header-row">
          <div class="message-author">{{ msg.username }}</div>
          
          <!-- Badges Relation -->
          <span *ngIf="msg.relation_type === 'attack'" class="badge badge-attack">âš”ï¸ ATTACK</span>
          <span *ngIf="msg.relation_type === 'support'" class="badge badge-support">ğŸ›¡ï¸ SUPPORT</span>
          <span *ngIf="msg.target_id" class="target-ref">â†³ Ref #{{msg.target_id}}</span>
        </div>

        <!-- CONTENU -->
        <div class="message-content">{{ msg.content }}</div>

        <!-- FEEDBACK IA (Critique) -->
        <div *ngIf="msg.feedback" class="ai-feedback">
          ğŸ¤– <em>Analyze: {{ msg.feedback }}</em>
        </div>

        <!-- ZONE SUGGESTIONS (Le Coach) -->
        <!-- On affiche le bouton seulement pour les messages adverses gagnants -->
        <div *ngIf="msg.username !== username" class="suggestion-area">
  
          <button (click)="askForHelp(msg.id)" class="btn-help" *ngIf="!suggestionsMap[msg.id]">
            {{ loadingSuggestionId === msg.id ? 'Thinking...' : 'ğŸ’¡ Suggest Counter-Argument' }}
          </button>


          <!-- Liste des suggestions -->
          <div *ngIf="suggestionsMap[msg.id]" class="suggestions-box">
            <small><strong>AI Suggestions:</strong></small>
            <ul>
              <li *ngFor="let idea of suggestionsMap[msg.id]">{{ idea }}</li>
            </ul>
          </div>
        </div>

      </div>
      <!-- Fin Bulle -->

    </div>
  </div>

  <footer class="message-form-container">
    <form (ngSubmit)="sendMessage()">
      <input 
        type="text" 
        placeholder="Type your message..."
        [(ngModel)]="newMessageContent"
        name="newMessageContent"
        autocomplete="off"
      />
      <button type="submit" [disabled]="!newMessageContent.trim()">Send</button>
    </form>
  </footer>
</div>